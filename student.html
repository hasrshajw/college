<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - College Management System</title>
    <style>
        :root {
            --primary-color: #3498db; --danger-color: #e74c3c; --success-color: #27ae60; --warning-color: #f39c12;
            --light-bg: #f4f7f9; --dark-text: #2c3e50; --light-text: #7f8c8d;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-bg); margin: 0; padding: 2em 0; display: flex;
            justify-content: center; align-items: flex-start; min-height: 100vh; color: var(--dark-text);
        }
        .container {
            width: 95%; max-width: 900px; background: white; padding: 2em; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 { color: var(--dark-text); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 1em; margin-bottom: 1em; }
        .header-actions { display: flex; gap: 1em; }
        .btn { border: none; padding: 10px 15px; font-size: 14px; border-radius: 4px; cursor: pointer; color: white; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-logout { background-color: var(--danger-color); }
        .btn-switch { background-color: var(--warning-color); }
        
        /* Profile Selector View */
        #profile-selector-view { text-align: center; }
        .profile-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5em; margin-top: 2em; }
        .profile-selector-card { display: flex; align-items: center; gap: 1em; background: #fff; border: 1px solid #ddd; padding: 1.5em; border-radius: 8px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: left; }
        .profile-selector-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 4px solid var(--primary-color); }
        .profile-selector-card .icon { flex-shrink: 0; }
        .profile-selector-card h3 { margin: 0 0 0.25em 0; }
        .profile-selector-card p { margin: 0; color: var(--light-text); font-size: 0.9em; }

        /* Student Dashboard View */
        .dashboard-header { background: var(--light-bg); padding: 1.5em; border-radius: 8px; margin-bottom: 2em; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-header h2 { margin: 0; }
        .dashboard-tabs { border-bottom: 2px solid #eee; margin-bottom: 1.5em; }
        .tab-button { background: none; border: none; padding: 10px 15px; font-size: 16px; cursor: pointer; border-bottom: 3px solid transparent; color: var(--light-text); font-weight: 500; }
        .tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Stat Card for Attendance */
        .stat-card { background: white; border-radius: 8px; padding: 1.5em; text-align: center; border: 1px solid #eee; }
        .stat-card .stat-value { font-size: 3.5em; font-weight: 700; color: var(--primary-color); line-height: 1; }
        .stat-card .stat-label { font-weight: 500; color: var(--light-text); margin-top: 0.5em; }
        .stat-card .stat-subtext { font-size: 0.9em; color: var(--light-text); }

        /* Marks Table */
        .marks-table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .marks-table th, .marks-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .marks-table th { background-color: var(--light-bg); }
        .marks-table tr:hover { background-color: #f9f9f9; }
        .marks-pass { color: var(--success-color); font-weight: bold; }
        .marks-fail { color: var(--danger-color); font-weight: bold; }
    </style>
</head>
<body>
    <div class="container" style="display: none;">
        <div id="app-header" class="header">
            <div class="header-info"><h1>Student Portal</h1><p>Logged in as: <strong id="user-email"></strong></p></div>
            <div class="header-actions">
                <button id="logout-btn" class="btn btn-logout">Logout</button>
            </div>
        </div>

        <!-- View 1: Profile Selector -->
        <div id="profile-selector-view" style="display: none;">
            <h2>Select a Student Profile</h2>
            <p>This account is linked to multiple students. Please choose a profile to view.</p>
            <div id="profile-list" class="profile-list"></div>
        </div>

        <!-- View 2: Main Student Dashboard -->
        <div id="student-dashboard-view" style="display: none;">
            <div id="dashboard-header" class="dashboard-header"></div>
            <div class="dashboard-tabs">
                <button class="tab-button active" onclick="showDashboardTab('attendance')">Attendance Report</button>
                <button class="tab-button" onclick="showDashboardTab('exams')">Exam Results</button>
            </div>
            
            <div id="attendance-content" class="tab-content active">
                <div id="attendance-summary-container" class="stat-card"></div>
            </div>
            
            <div id="exam-results-content" class="tab-content">
                <div id="exam-marks-container"></div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAtDp9cTE1fYFM2PZjgQ1r1YBoSOcwhIS8",
            authDomain: "collage-management-696b3.firebaseapp.com",
            projectId: "collage-management-696b3",
            storageBucket: "collage-management-696b3.firebasestorage.app",
            messagingSenderId: "489625618034",
            appId: "1:489625618034:web:f6ba20e80715f70e4264eb",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const mainContainer = document.querySelector('.container');
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const profileSelectorView = document.getElementById('profile-selector-view');
        const profileList = document.getElementById('profile-list');
        const studentDashboardView = document.getElementById('student-dashboard-view');
        const dashboardHeader = document.getElementById('dashboard-header');
        const attendanceSummaryContainer = document.getElementById('attendance-summary-container');
        const examMarksContainer = document.getElementById('exam-marks-container');

        // Global State
        let linkedStudentProfiles = [];
        let CURRENT_ACADEMIC_YEAR = null;
        let attendanceUnsubscribe = null;

        // --- AUTH & INITIALIZATION ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                const userDoc = await db.collection('users').doc(user.email).get();
                if (userDoc.exists && userDoc.data().role === 'student') {
                    await fetchGlobalSettings();
                    mainContainer.style.display = 'block';
                    userEmailEl.textContent = user.email;
                    initializeStudentDashboard(user.email);
                } else {
                    handleAuthError('Access Denied. You do not have student permissions.');
                }
            } else { window.location.href = 'index.html'; }
        });

        function handleAuthError(message) { alert(message); auth.signOut().then(() => window.location.href = 'index.html'); }
        logoutBtn.onclick = () => { if (attendanceUnsubscribe) attendanceUnsubscribe(); auth.signOut(); };
        
        async function fetchGlobalSettings() {
            try { const doc = await db.collection('settings').doc('global').get(); if (doc.exists) CURRENT_ACADEMIC_YEAR = doc.data().currentAcademicYear; } 
            catch(e) { console.error("Could not fetch academic year settings."); CURRENT_ACADEMIC_YEAR = null; }
        }

        async function initializeStudentDashboard(email) {
            const studentSnap = await db.collection('students').where('email', '==', email).get();
            if (studentSnap.empty) { studentDashboardView.innerHTML = '<h2>Error: Your student profile could not be found. Please contact an administrator.</h2>'; studentDashboardView.style.display = 'block'; return; }
            linkedStudentProfiles = studentSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (linkedStudentProfiles.length > 1) { showProfileSelector(); } 
            else { loadDashboardForStudent(linkedStudentProfiles[0]); }
        }

        // --- UI VIEW MANAGEMENT ---
        function showProfileSelector() {
            studentDashboardView.style.display = 'none';
            profileSelectorView.style.display = 'block';
            profileList.innerHTML = linkedStudentProfiles.map(profile => `
                <div class="profile-selector-card" data-id="${profile.id}">
                    <div class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                    <div>
                        <h3>${profile.name}</h3>
                        <p>Class: ${profile.class} | Roll No: ${profile.rollNo}</p>
                    </div>
                </div>`).join('');
            
            document.querySelectorAll('.profile-selector-card').forEach(card => {
                card.onclick = () => {
                    const selectedProfile = linkedStudentProfiles.find(p => p.id === card.dataset.id);
                    loadDashboardForStudent(selectedProfile);
                };
            });
        }

        function loadDashboardForStudent(profile) {
            profileSelectorView.style.display = 'none';
            studentDashboardView.style.display = 'block';
            
            dashboardHeader.innerHTML = `
                <div>
                    <h2>${profile.name}</h2>
                    <p style="margin:0; color: var(--light-text);">Class: ${profile.class} | Roll No: ${profile.rollNo} | Year: ${profile.academicYear || 'N/A'}</p>
                </div>
                ${linkedStudentProfiles.length > 1 ? `<button class="btn btn-switch" onclick="showProfileSelector()">Switch Student</button>` : ''}
            `;
            
            // Set default tab and load data
            showDashboardTab('attendance');
            listenForStudentAttendance(profile.id, profile.academicYear);
            fetchExamMarks(profile.id, profile.academicYear);
        }

        function showDashboardTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`[onclick="showDashboardTab('${tabName}')"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`${tabName === 'exams' ? 'exam-results' : tabName}-content`).classList.add('active');
        }

        // --- DATA FETCHING & RENDERING FOR DASHBOARD ---
        function listenForStudentAttendance(studentId, academicYear) {
            if (attendanceUnsubscribe) attendanceUnsubscribe();
            let query = db.collection('attendance');
            if (academicYear) query = query.where('academicYear', '==', academicYear);

            attendanceUnsubscribe = query.onSnapshot(snap => {
                const myRecords = snap.docs.filter(doc => doc.data().records && doc.data().records[studentId]);
                renderAttendanceSummary(myRecords.length, myRecords.filter(d => d.data().records[studentId] === 'present').length);
            });
        }

        function renderAttendanceSummary(total, present) {
            if (total === 0) {
                attendanceSummaryContainer.innerHTML = '<p>No attendance records found yet.</p>';
                return;
            }
            const percentage = Math.round((present / total) * 100);
            attendanceSummaryContainer.innerHTML = `
                <div class="stat-value">${percentage}%</div>
                <div class="stat-label">Overall Attendance</div>
                <p class="stat-subtext">${present} of ${total} days attended</p>`;
        }

        async function fetchExamMarks(studentId, academicYear) {
            examMarksContainer.innerHTML = '<p>Loading exam results...</p>';
            const studentYear = academicYear || CURRENT_ACADEMIC_YEAR;
            if(!studentYear) { examMarksContainer.innerHTML = '<p>Academic year not set. Cannot fetch exams.</p>'; return; }

            const examsSnap = await db.collection('exams').where('academicYear', '==', studentYear).get();
            if (examsSnap.empty) { examMarksContainer.innerHTML = '<p>No exams scheduled for this year.</p>'; return; }

            const exams = examsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const examIds = exams.map(e => e.id);

            const marksSnap = await db.collection('marks').where('studentId', '==', studentId).where('examId', 'in', examIds).get();
            if (marksSnap.empty) { examMarksContainer.innerHTML = '<p>No marks have been entered yet.</p>'; return; }

            let tableHtml = '<table class="marks-table"><thead><tr><th>Exam</th><th>Subject</th><th>Marks Obtained</th><th>Max Marks</th></tr></thead><tbody>';
            marksSnap.forEach(doc => {
                const markData = doc.data();
                const exam = exams.find(e => e.id === markData.examId);
                for (const subject in markData.marks) {
                    const marksKey = `CLASS_${markData.class}_${subject.replace(/\s+/g, '_').toUpperCase()}`;
                    const maxMarks = exam.marksStructure[marksKey] || 0;
                    const obtainedMarks = markData.marks[subject];
                    const passMark = maxMarks * 0.4; // Assuming 40% is passing
                    const statusClass = obtainedMarks >= passMark ? 'marks-pass' : 'marks-fail';

                    tableHtml += `<tr>
                                    <td>${markData.examName}</td>
                                    <td>${subject}</td>
                                    <td class="${statusClass}">${obtainedMarks}</td>
                                    <td>${maxMarks}</td>
                                  </tr>`;
                }
            });
            tableHtml += '</tbody></table>';
            examMarksContainer.innerHTML = tableHtml;
        }
    </script>
</body>
</html>
