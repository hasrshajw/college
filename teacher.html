<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - College Management System</title>
    <style>
        :root {
            --primary-color: #3498db; --danger-color: #e74c3c; --success-color: #27ae60; --light-bg: #f4f7f9; --dark-text: #2c3e50;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-bg); margin: 0; padding: 2em 0; display: flex;
            justify-content: center; align-items: flex-start; min-height: 100vh; color: var(--dark-text);
        }
        .container {
            width: 95%; max-width: 1200px; background: white; padding: 2em; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 1em; margin-bottom: 1.5em; flex-wrap: wrap; gap: 1em; }
        .header-info h1 { margin: 0; }
        .header-info p { margin: 0; font-size: 0.9em; color: #7f8c8d; }
        .header-nav { display: flex; align-items: center; gap: 0.5em; }
        .btn { border: none; padding: 10px 15px; font-size: 14px; border-radius: 4px; cursor: pointer; color: white; text-decoration: none; text-align: center; }
        .btn-nav { background-color: var(--primary-color); }
        .btn-logout { background-color: var(--danger-color); }
        .year-display { font-size: 1.2em; font-weight: bold; color: var(--primary-color); text-align: right; margin-bottom: 2em; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2em;
        }
        .dashboard-widget {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 1.5em;
        }
        .dashboard-widget h3 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5em;
        }

        .timetable { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .timetable th, .timetable td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .timetable th { background-color: var(--light-bg); }
        
        .notice-item { border-bottom: 1px solid #eee; padding-bottom: 1em; margin-bottom: 1em; }
        .notice-item:last-child { border-bottom: none; margin-bottom: 0; }
        .notice-item h4 { margin: 0 0 0.5em 0; display: flex; align-items: center; gap: 0.5em; }
        .notice-item p { margin: 0; white-space: pre-wrap; color: #555; }
        .notice-tag { font-size: 0.75em; font-weight: 600; color: white; padding: 0.2em 0.6em; border-radius: 10px; }
        .tag-Urgent { background-color: #e67e22; }
        .tag-Event { background-color: #9b59b6; }
        .tag-Exam { background-color: #1abc9c; }
        .tag-General { background-color: var(--primary-color); }
    </style>
</head>
<body>
    <div class="container" style="display: none;">
        <div id="app-header" class="header">
            <div class="header-info">
                <h1>Teacher Dashboard</h1>
                <p>Logged in as: <strong id="user-email"></strong></p>
            </div>
            <nav class="header-nav">
                <a href="teacher-attendance.html" class="btn btn-nav">Attendance</a>
                <a href="teacher-marks.html" class="btn btn-nav">Marks Entry</a>
                <a href="reports.html" class="btn btn-nav">Reports</a>
                <a href="profile.html" class="btn btn-nav">My Profile</a>
                <button id="logout-btn" class="btn btn-logout">Logout</button>
            </nav>
        </div>
        <div class="year-display">Current Academic Year: <span id="current-year-display">Loading...</span></div>
        
        <h2>Welcome, <span id="teacher-name-display"></span>!</h2>
        <div class="dashboard-grid">
            <div class="dashboard-widget">
                <h3>Today's Schedule</h3>
                <div id="timetable-container"></div>
            </div>
            <div class="dashboard-widget">
                <h3>Notice Board</h3>
                <div id="notice-board-container"></div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtDp9cTE1fYFM2PZjgQ1r1YBoSOcwhIS8",
            authDomain: "collage-management-696b3.firebaseapp.com",
            projectId: "collage-management-696b3",
            storageBucket: "collage-management-696b3.firebasestorage.app",
            messagingSenderId: "489625618034",
            appId: "1:489625618034:web:f6ba20e80715f70e4264eb",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- GLOBAL STATE ---
        let CURRENT_ACADEMIC_YEAR = null;
        let currentTeacher = null;
        const timeSlots = ["09:00-10:00", "10:00-11:00", "11:00-12:00", "12:00-01:00", "02:00-03:00", "03:00-04:00"];

        // --- DOM ELEMENTS ---
        const mainContainer = document.querySelector('.container');
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const teacherNameDisplay = document.getElementById('teacher-name-display');
        const timetableContainer = document.getElementById('timetable-container');
        const noticeBoardContainer = document.getElementById('notice-board-container');
        
        // --- AUTHENTICATION & PAGE SETUP ---
        // This is the security gate for the page. It ensures only logged-in teachers can see it.
        auth.onAuthStateChanged(async user => {
            if (user) {
                const userDoc = await db.collection('users').doc(user.email).get();
                if (userDoc.exists && userDoc.data().role === 'teacher') {
                    // Fetch the teacher's profile to get their name and ID.
                    const teacherSnap = await db.collection('teachers').where('email', '==', user.email).limit(1).get();
                    if (!teacherSnap.empty) {
                        currentTeacher = { id: teacherSnap.docs[0].id, ...teacherSnap.docs[0].data() };
                        mainContainer.style.display = 'block';
                        userEmailEl.textContent = user.email;
                        teacherNameDisplay.textContent = currentTeacher.name;
                        await initializeDashboard();
                    } else { 
                        handleAuthError('Your teacher profile could not be found.'); 
                    }
                } else { 
                    handleAuthError('Access Denied. You do not have teacher permissions.'); 
                }
            } else { 
                window.location.href = 'index.html'; 
            }
        });

        // A centralized function for handling any authentication or permission errors.
        function handleAuthError(message) {
            alert(message);
            auth.signOut().then(() => window.location.href = 'index.html');
        }

        // Handles user logout.
        logoutBtn.onclick = () => auth.signOut();
        
        // Main function to start the page's logic after the user is verified.
        async function initializeDashboard() {
            try {
                await fetchGlobalSettings();
                // Fetch all necessary data in parallel for a faster load time.
                await Promise.all([
                    fetchTimetableAndSubjects(),
                    fetchNotices()
                ]);
            } catch (error) {
                document.body.innerHTML = `<h1>Critical Error</h1><p>${error.message}</p><p>Please ask the administrator to set the 'currentAcademicYear' in the system settings.</p>`;
            }
        }
        
        // Fetches the single source of truth for the academic year from Firestore.
        async function fetchGlobalSettings() {
            const settingsRef = db.collection('settings').doc('global');
            const doc = await settingsRef.get();
            if (!doc.exists || !doc.data().currentAcademicYear) { throw new Error("Global settings not found."); }
            CURRENT_ACADEMIC_YEAR = doc.data().currentAcademicYear;
            document.getElementById('current-year-display').textContent = CURRENT_ACADEMIC_YEAR;
        }

        // --- DASHBOARD WIDGETS ---
        
        // Fetches both the timetables and the subjects assigned to this teacher.
        async function fetchTimetableAndSubjects() {
            timetableContainer.innerHTML = "<p>Loading your schedule...</p>";
            if (!currentTeacher || !CURRENT_ACADEMIC_YEAR) return;

            // Get all subjects this teacher is assigned to for the current year.
            const subjectsSnap = await db.collection('subjects').where('teacherId', '==', currentTeacher.id).where('academicYear', '==', CURRENT_ACADEMIC_YEAR).get();
            const mySubjects = subjectsSnap.docs.map(doc => doc.data());
            const myClasses = [...new Set(mySubjects.map(s => s.className))];

            if (myClasses.length === 0) {
                timetableContainer.innerHTML = "<p>You are not assigned to any classes for this academic year.</p>";
                return;
            }

            // Get all timetables for the current year.
            const timetablesSnap = await db.collection('timetables').where('academicYear', '==', CURRENT_ACADEMIC_YEAR).get();
            const allTimetables = timetablesSnap.docs.map(doc => doc.data());
            
            renderDailyTimetable(mySubjects, allTimetables);
        }

        // Renders the timetable for the current day.
        function renderDailyTimetable(mySubjects, allTimetables) {
            const today = new Date().toLocaleString('en-us', {weekday: 'long'}).toLowerCase();
            const myClasses = mySubjects.map(s => s.className);
            let dailySchedule = [];
            
            // Filter all timetables to find just the ones for the teacher's classes.
            allTimetables.filter(tt => myClasses.includes(tt.className)).forEach(timetable => {
                // Check if there's a schedule for today.
                if (timetable.schedule && timetable.schedule[today]) {
                    // Go through each period of the day.
                    timetable.schedule[today].forEach((subjectName, periodIndex) => {
                        // Check if the subject in the timetable is one that this teacher actually teaches for that class.
                        if (subjectName && mySubjects.some(s => s.className === timetable.className && s.subjectName === subjectName)) {
                            dailySchedule.push({ time: timeSlots[periodIndex], className: timetable.className, subject: subjectName });
                        }
                    });
                }
            });

            if (dailySchedule.length === 0) {
                timetableContainer.innerHTML = "<p>You have no classes scheduled for today.</p>";
                return;
            }

            // Sort by time and render the HTML table.
            dailySchedule.sort((a,b) => a.time.localeCompare(b.time));
            let tableHtml = '<table class="timetable"><thead><tr><th>Time</th><th>Class</th><th>Subject</th></tr></thead><tbody>';
            dailySchedule.forEach(period => {
                tableHtml += `<tr><td>${period.time}</td><td>${period.className}</td><td>${period.subject}</td></tr>`;
            });
            tableHtml += `</tbody></table>`;
            timetableContainer.innerHTML = tableHtml;
        }

        // Fetches and displays the latest school-wide notices.
        async function fetchNotices() {
            noticeBoardContainer.innerHTML = "<p>Loading notices...</p>";
            const now = new Date();
            
            // Query for notices that are targeted to this teacher or everyone.
            const querySnap = await db.collection('notices')
                .where('audience', 'in', ['everyone', 'teachers'])
                .orderBy('publishedAt', 'desc')
                .get();

            // Filter out expired notices in JavaScript.
            const notices = querySnap.docs
                .map(doc => doc.data())
                .filter(notice => !notice.expiryDate || notice.expiryDate.toDate() > now)
                .slice(0, 5); // Show the latest 5.
            
            if (notices.length === 0) {
                noticeBoardContainer.innerHTML = "<p>No recent notices.</p>";
                return;
            }
            noticeBoardContainer.innerHTML = notices.map(notice => {
                return `<div class="notice-item">
                            <h4><span class="notice-tag tag-${notice.type}">${notice.type}</span>${notice.title}</h4>
                            <p>${notice.message}</p>
                        </div>`
            }).join('');
        }
    </script>
</body>
</html>
