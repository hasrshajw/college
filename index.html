<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome - College Management Portal</title>
    <style>
        :root {
            --primary-color: #3498db; --danger-color: #e74c3c; --dark-text: #2c3e50;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        .login-wrapper {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .login-image-panel {
            flex: 1;
            background-image: url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .login-image-panel::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.3);
        }

        .login-form-panel {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            padding: 2em;
        }
        .login-container {
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: fadeIn 1s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 {
            color: var(--dark-text);
            font-size: 2.5em;
            margin-bottom: 0.25em;
        }
        p {
            color: #7f8c8d;
            margin-bottom: 2em;
        }

        .google-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .google-btn:hover {
            background-color: #357ae8;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .google-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .google-btn svg {
            background-color: white;
            border-radius: 50%;
            padding: 2px;
        }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            color: var(--danger-color);
            background-color: rgba(231, 76, 60, 0.1);
            border: 1px solid rgba(231, 76, 60, 0.2);
            padding: 1em;
            border-radius: 4px;
            margin-top: 1.5em;
            font-weight: 500;
            text-align: left;
        }
        
        @media (max-width: 768px) {
            .login-image-panel { display: none; }
            .login-form-panel { flex-basis: 100%; }
        }
    </style>
</head>
<body>

    <div class="login-wrapper">
        <div class="login-image-panel"></div>
        <div class="login-form-panel">
            <div class="login-container">
                <h1>Welcome Back</h1>
                <p>Sign in to access the Academic Portal.</p>
                <button id="login-btn" class="google-btn">
                    <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.42-4.55H24v8.51h12.8c-.57 3.01-2.2 5.59-4.7 7.37l7.98 6.19C45.33 36.63 48 31.02 48 24c0-.66-.07-1.31-.18-1.95H46.98z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.98-6.19c-2.11 1.45-4.81 2.3-7.91 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                    <span id="login-btn-text">Sign in with Google</span>
                </button>
                <p id="auth-error" class="error-message" style="display: none;"></p>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAtDp9cTE1fYFM2PZjgQ1r1YBoSOcwhIS8",
            authDomain: "collage-management-696b3.firebaseapp.com",
            projectId: "collage-management-696b3",
            storageBucket: "collage-management-696b3.firebasestorage.app",
            messagingSenderId: "489625618034",
            appId: "1:489625618034:web:f6ba20e80715f70e4264eb",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const adminEmail = "harshavardhanjw@gmail.com";

        const loginBtn = document.getElementById('login-btn');
        const loginBtnText = document.getElementById('login-btn-text');
        const authErrorEl = document.getElementById('auth-error');

        loginBtn.onclick = () => {
            authErrorEl.style.display = 'none';
            setButtonLoading(true);
            auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(error => {
                authErrorEl.textContent = `Error: ${error.message}`;
                authErrorEl.style.display = 'block';
                setButtonLoading(false);
            });
        };

        auth.onAuthStateChanged(user => {
            if (user) {
                setButtonLoading(true);
                loginBtnText.textContent = 'Verifying account...';
                checkUserRoleAndRedirect(user);
            } else {
                setButtonLoading(false);
            }
        });

        async function checkUserRoleAndRedirect(user) {
            // Priority 1: Check for Admin
            if (user.email === adminEmail) {
                window.location.href = 'admin.html';
                return;
            }
            
            // Priority 2: Check for an existing, defined role in the `users` collection
            const userDoc = await db.collection('users').doc(user.email).get();
            if (userDoc.exists) {
                const role = userDoc.data().role;
                if (role === 'student') { window.location.href = 'student.html'; return; } 
                if (role === 'teacher') { window.location.href = 'teacher.html'; return; }
                if (role === 'accountant') { window.location.href = 'manage-fees.html'; return; }
                handlePendingUser('Your account role is not configured. Please contact an admin.');
                return;
            }

            // Priority 3: ** SELF-HEALING STEP **
            // If no role exists, check if a profile was pre-created for this email.
            const studentProfileQuery = db.collection('students').where('email', '==', user.email).limit(1);
            const teacherProfileQuery = db.collection('teachers').where('email', '==', user.email).limit(1);
            
            const [studentSnap, teacherSnap] = await Promise.all([studentProfileQuery.get(), teacherProfileQuery.get()]);

            const batch = db.batch();
            
            if (!studentSnap.empty) {
                // Found a pre-created student profile. Atomically create their role.
                batch.set(db.collection('users').doc(user.email), { role: 'student' });
                batch.delete(db.collection('pending_users').doc(user.email)); // Clean up pending list if they were there
                await batch.commit();
                window.location.href = 'student.html'; // Redirect immediately
                return;
            }

            if (!teacherSnap.empty) {
                // Found a pre-created teacher profile. Atomically create their role.
                batch.set(db.collection('users').doc(user.email), { role: 'teacher' });
                batch.delete(db.collection('pending_users').doc(user.email));
                await batch.commit();
                window.location.href = 'teacher.html'; // Redirect immediately
                return;
            }

            // Priority 4: If all checks fail, the user is genuinely new and unassigned.
            await db.collection('pending_users').doc(user.email).set({ 
                email: user.email, 
                createdAt: firebase.firestore.FieldValue.serverTimestamp() 
            }, { merge: true });
            handlePendingUser('Your account is pending approval by the administrator.');
        }

        function handlePendingUser(message) {
            authErrorEl.textContent = message;
            authErrorEl.style.display = 'block';
            auth.signOut();
            setButtonLoading(false);
        }

        function setButtonLoading(isLoading) {
            const spinner = loginBtn.querySelector('.spinner');
            if (isLoading) {
                loginBtn.disabled = true;
                loginBtnText.textContent = 'Signing in...';
                if (!spinner) {
                    const newSpinner = document.createElement('div');
                    newSpinner.className = 'spinner';
                    loginBtn.prepend(newSpinner);
                }
            } else {
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Sign in with Google';
                if (spinner) spinner.remove();
            }
        }
    </script>
</body>
</html>
