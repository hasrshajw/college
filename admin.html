<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - College Management System</title>
    <style>
        :root {
            --primary-color: #3498db; --danger-color: #e74c3c; --success-color: #27ae60; --light-bg: #f4f7f9; --dark-text: #2c3e50;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--light-bg); margin: 0; padding: 2em 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; color: var(--dark-text); }
        .container { width: 95%; max-width: 1200px; background: white; padding: 2em; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 1em; margin-bottom: 2em; }
        .header-info p { margin: 0; font-size: 0.9em; }
        .btn { border: none; padding: 10px 15px; font-size: 14px; border-radius: 4px; cursor: pointer; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-logout { background-color: var(--danger-color); }
        .btn-edit { background-color: var(--primary-color); }
        .btn-delete { background-color: var(--danger-color); }
        .content { display: none; gap: 2em; flex-wrap: wrap; }
        .content.active { display: flex; }
        .form-container { flex: 1; min-width: 350px; padding-right: 2em; border-right: 1px solid #eee; }
        .list-container { flex: 2; min-width: 400px; }
        form { display: flex; flex-direction: column; gap: 1.2em; text-align: left; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button[type="submit"] { background-color: var(--success-color); color: white; padding: 12px; border: none; font-size: 16px; cursor: pointer; }
        .item-card { background: #ecf0f1; padding: 1em; border-radius: 4px; margin-bottom: 0.8em; border-left: 5px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .item-card > div:first-child { flex-grow: 1; }
        .tabs { border-bottom: 2px solid #eee; margin-bottom: 1.5em; }
        .tab-button { background: none; border: none; padding: 10px 15px; font-size: 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; position: relative; }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container" style="display: none;">
        <div id="app-header" class="header">
            <div class="header-info"><h1 id="header-title">Admin Dashboard</h1><p>Logged in as: <strong id="user-email"></strong></p></div>
            <button id="logout-btn" class="btn btn-logout">Logout</button>
        </div>

        <div id="admin-view">
            <div class="tabs"><!-- Tabs here --></div>
            <!-- All content divs here -->
        </div>
    </div>
    
    <!-- Universal Modal for Editing -->
    <div id="edit-modal" class="modal"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = { /* Your Config */ };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const adminEmail = "harshavardhanjw@gmail.com";

        // --- DOM Elements ---
        const mainContainer = document.querySelector('.container');
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const adminView = document.getElementById('admin-view');
        const editModal = document.getElementById('edit-modal');
        
        // --- Global State ---
        let allUnsubscribes = [], studentsCache = [], teachersCache = [], subjectsCache = [], examsCache = [];

        // --- Auth & Initialization ---
        auth.onAuthStateChanged(user => {
            if (user && user.email === adminEmail) {
                mainContainer.style.display = 'block';
                userEmailEl.textContent = user.email;
                initializeAdminDashboard();
            } else { window.location.href = 'index.html'; }
        });
        logoutBtn.onclick = () => { /* Logout logic */ };

        function initializeAdminDashboard() {
            renderLayout(); // Render the static HTML layout
            startDataListeners();
            setupEventListeners();
        }

        // --- Layout Rendering ---
        function renderLayout() {
            adminView.innerHTML = `
                <div class="tabs">
                    <button class="tab-button active" onclick="showTab('students')">Students</button>
                    <button class="tab-button" onclick="showTab('teachers')">Teachers</button>
                    <button class="tab-button" onclick="showTab('subjects')">Subjects</button>
                    <button class="tab-button" onclick="showTab('exams')">Exams</button>
                </div>
                <div id="students-content" class="content active"><div class="form-container"><h2>Create Student</h2><form id="create-student-form"><!-- ... --></form></div><div class="list-container"><h2>Existing Students</h2><div id="student-list"></div></div></div>
                <div id="teachers-content" class="content"><div class="form-container"><h2>Create Teacher</h2><form id="create-teacher-form"><!-- ... --></form></div><div class="list-container"><h2>Existing Teachers</h2><div id="teacher-list"></div></div></div>
                <div id="subjects-content" class="content"><div class="form-container"><h2>Create Subject</h2><form id="create-subject-form"><!-- ... --></form></div><div class="list-container"><h2>Existing Subjects</h2><div id="subject-list"></div></div></div>
                <div id="exams-content" class="content"><div class="form-container"><h2>Create Exam</h2><form id="create-exam-form"><!-- ... --></form></div><div class="list-container"><h2>Existing Exams</h2><div id="exam-list"></div></div></div>
            `;
            // Populate form contents (omitted for brevity, they are standard forms)
        }

        // --- Data Listeners ---
        function startDataListeners() {
            // ... all listenFor... functions go here
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            adminView.addEventListener('submit', handleFormSubmissions);
            adminView.addEventListener('click', handleListActions);
            editModal.addEventListener('submit', handleUpdateSubmissions);
        }

        function handleFormSubmissions(e) {
            e.preventDefault();
            // ... Logic for all CREATE forms
        }

        function handleListActions(e) {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;

            if (target.classList.contains('btn-edit')) {
                if (target.closest('#student-list')) openEditStudentModal(id);
                if (target.closest('#teacher-list')) openEditTeacherModal(id);
                if (target.closest('#subject-list')) openEditSubjectModal(id);
                if (target.closest('#exam-list')) openEditExamModal(id);
            } else if (target.classList.contains('btn-delete')) {
                if (target.closest('#student-list')) handleDelete(id, 'student', 'students');
                if (target.closest('#teacher-list')) handleSafeTeacherDelete(id, target.dataset.email);
                if (target.closest('#subject-list')) handleDelete(id, 'subject', 'subjects');
                if (target.closest('#exam-list')) handleDelete(id, 'exam', 'exams');
            }
        }

        function handleUpdateSubmissions(e) {
            e.preventDefault();
            if (e.target.id === 'edit-student-form') handleUpdateStudent(e);
            if (e.target.id === 'edit-teacher-form') handleUpdateTeacher(e);
            if (e.target.id === 'edit-subject-form') handleUpdateSubject(e);
            if (e.target.id === 'edit-exam-form') handleUpdateExam(e);
        }

        // --- Modal Control ---
        function openModal(html) {
            editModal.innerHTML = `<div class="modal-content"><span class="close-btn" onclick="closeModal()">&times;</span>${html}</div>`;
            editModal.style.display = 'flex';
        }
        function closeModal() {
            editModal.style.display = 'none';
            editModal.innerHTML = '';
        }

        // --- EDIT MODAL & UPDATE LOGIC ---

        // STUDENT EDIT
        function openEditStudentModal(id) {
            const student = studentsCache.find(s => s.id === id);
            const html = `<h2>Edit Student</h2><form id="edit-student-form" data-id="${id}"><!-- form fields with values --></form>`;
            openModal(html);
        }
        async function handleUpdateStudent(e) {
            const id = e.target.dataset.id;
            // ... get form values
            await db.collection('students').doc(id).update({ name, rollNo, class: className });
            closeModal();
        }

        // TEACHER EDIT (with data integrity)
        function openEditTeacherModal(id) {
            const teacher = teachersCache.find(t => t.id === id);
            const html = `<h2>Edit Teacher</h2><form id="edit-teacher-form" data-id="${id}"><label>Name:</label><input value="${teacher.name}"><label>Email:</label><input value="${teacher.email}" readonly></form>`;
            openModal(html);
        }
        async function handleUpdateTeacher(e) {
            const id = e.target.dataset.id;
            const newName = e.target.querySelector('input[type="text"]').value;
            const batch = db.batch();
            // 1. Update teacher document
            batch.update(db.collection('teachers').doc(id), { name: newName });
            // 2. Find and update all subjects taught by this teacher
            const subjectsToUpdate = await db.collection('subjects').where('teacherId', '==', id).get();
            subjectsToUpdate.forEach(doc => batch.update(doc.ref, { teacherName: newName }));
            await batch.commit();
            closeModal();
        }

        // SUBJECT EDIT
        function openEditSubjectModal(id) {
            const subject = subjectsCache.find(s => s.id === id);
            // ... build form with teacher dropdown, selecting the correct teacher
            openModal(html);
        }
        async function handleUpdateSubject(e) {
            // ... get values including new teacherId and teacherName
            await db.collection('subjects').doc(id).update({ className, subjectName, teacherId, teacherName });
            closeModal();
        }

        // EXAM EDIT (Name only for simplicity)
        function openEditExamModal(id) {
            const exam = examsCache.find(ex => ex.id === id);
            const html = `<h2>Edit Exam</h2><form id="edit-exam-form" data-id="${id}"><label>Exam Name:</label><input value="${exam.examName}"></form>`;
            openModal(html);
        }
        async function handleUpdateExam(e) {
            const id = e.target.dataset.id;
            const newName = e.target.querySelector('input').value;
            await db.collection('exams').doc(id).update({ examName: newName });
            closeModal();
        }

        // --- DELETE LOGIC ---
        async function handleSafeTeacherDelete(teacherId, teacherEmail) {
            if (!confirm(`Are you sure? This will unassign the teacher from all subjects.`)) return;
            const batch = db.batch();
            const subjectsQuery = await db.collection('subjects').where('teacherId', '==', teacherId).get();
            subjectsQuery.forEach(doc => batch.update(doc.ref, { teacherId: null, teacherName: null }));
            batch.delete(db.collection('teachers').doc(teacherId));
            batch.delete(db.collection('users').doc(teacherEmail));
            await batch.commit();
            alert('Teacher deleted and unassigned successfully.');
        }
        function handleDelete(id, itemName, collectionName) {
            if (confirm(`Are you sure you want to delete this ${itemName}?`)) {
                db.collection(collectionName).doc(id).delete();
            }
        }
        
    </script>
</body>
</html>
