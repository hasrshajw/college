<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - College Management System</title>
    <style>
        :root {
            --primary-color: #3498db; --danger-color: #e74c3c; --success-color: #27ae60; --warning-color: #f39c12;
            --light-bg: #f4f7f9; --dark-text: #2c3e50; --light-text: #7f8c8d;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-bg); margin: 0; padding: 2em 0; display: flex;
            justify-content: center; align-items: flex-start; min-height: 100vh; color: var(--dark-text);
        }
        .container {
            width: 95%; max-width: 1200px; background: white; padding: 2em; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 1em; margin-bottom: 2em; }
        .header-info p { margin: 0; font-size: 0.9em; color: var(--light-text); }
        .btn { border: none; padding: 10px 15px; font-size: 14px; border-radius: 4px; cursor: pointer; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-logout { background-color: var(--danger-color); }
        .btn-edit { background-color: var(--primary-color); }
        .btn-delete { background-color: var(--danger-color); }
        .content { display: none; gap: 2em; flex-wrap: wrap; }
        .content.active { display: flex; }
        .form-container, .teacher-form-container, .subject-form-container, .exam-form-container { flex: 1; min-width: 350px; padding-right: 2em; border-right: 1px solid #eee; }
        .list-container { flex: 2; min-width: 400px; }
        form { display: flex; flex-direction: column; gap: 1.2em; text-align: left; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button[type="submit"] { background-color: var(--success-color); color: white; padding: 12px; border: none; font-size: 16px; cursor: pointer; }
        button[type="submit"]:hover { opacity: 0.9; }
        .item-card { background: #ecf0f1; padding: 1em; border-radius: 4px; margin-bottom: 0.8em; border-left: 5px solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .item-card > div:first-child { flex-grow: 1; }
        .tabs { border-bottom: 2px solid #eee; margin-bottom: 1.5em; }
        .tab-button { background: none; border: none; padding: 10px 15px; font-size: 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-button.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: bold; }
        .marks-config { background: var(--light-bg); padding: 1em; border-radius: 5px; margin-top: 1em; }
        .marks-config-controls { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: center; }
        .marks-item { background: white; padding: 8px; border-radius: 4px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container" style="display: none;">
        <div id="app-header" class="header">
            <div class="header-info"><h1 id="header-title">Admin Dashboard</h1><p>Logged in as: <strong id="user-email"></strong></p></div>
            <button id="logout-btn" class="btn btn-logout">Logout</button>
        </div>

        <div id="admin-view">
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('students')">Students</button>
                <button class="tab-button" onclick="showTab('teachers')">Teachers</button>
                <button class="tab-button" onclick="showTab('subjects')">Subjects</button>
                <button class="tab-button" onclick="showTab('exams')">Exams</button>
            </div>
            
            <div id="students-content" class="content active">
                <div class="form-container"><h2>Create Student</h2><form id="create-student-form"><label>Full Name:</label><input type="text" id="name" required><label>Roll Number:</label><input type="text" id="rollNo" required><label>Class:</label><select id="class" required><option value="">-- Class --</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select><button type="submit">Create Student</button></form></div>
                <div class="list-container"><h2>Existing Students</h2><div id="student-list"></div></div>
            </div>
            
            <div id="teachers-content" class="content">
                 <div class="teacher-form-container"><h2>Create Teacher</h2><form id="create-teacher-form"><label>Full Name:</label><input type="text" id="teacher-name" required><label>Email:</label><input type="email" id="teacher-email" required placeholder="Must match Google account"><button type="submit">Create Teacher</button><p id="create-teacher-status"></p></form></div>
                 <div class="list-container"><h2>Existing Teachers</h2><div id="teacher-list"></div></div>
            </div>
            
            <div id="subjects-content" class="content">
                <div class="subject-form-container"><h2>Create Subject</h2><form id="create-subject-form"><label>Class:</label><select id="subject-class" required><option value="">-- Class --</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select><label>Subject Name:</label><input type="text" id="subject-name" required><label>Assign Teacher:</label><select id="subject-teacher" required><option value="">-- Select Teacher --</option></select><button type="submit">Create Subject</button><p id="create-subject-status"></p></form></div>
                <div class="list-container"><label>Filter by Class:</label><select id="subject-class-filter"><option value="all">All</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select><h2>Existing Subjects</h2><div id="subject-list"></div></div>
            </div>

            <div id="exams-content" class="content">
                <div class="exam-form-container"><h2>Create Exam</h2><form id="create-exam-form"><label>Exam Name:</label><input type="text" id="exam-name" required placeholder="e.g., Unit Test 1, Mid-Term"><div class="marks-config"><h4>Configure Marks</h4><div class="marks-config-controls"><select id="exam-class-select"><option value="">Class</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select><select id="exam-subject-select" disabled><option value="">Subject</option></select><input type="number" id="exam-max-marks" placeholder="Max Marks" min="1"><button type="button" id="add-exam-subject-btn" class="btn btn-edit">Add</button></div><div id="exam-marks-list" style="margin-top:1em;"></div></div><button type="submit">Create Exam</button><p id="create-exam-status"></p></form></div>
                <div class="list-container"><h2>Existing Exams</h2><div id="exam-list"></div></div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAtDp9cTE1fYFM2PZjgQ1r1YBoSOcwhIS8",
            authDomain: "collage-management-696b3.firebaseapp.com",
            projectId: "collage-management-696b3",
            storageBucket: "collage-management-696b3.firebasestorage.app",
            messagingSenderId: "489625618034",
            appId: "1:489625618034:web:f6ba20e80715f70e4264eb",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const adminEmail = "harshavardhanjw@gmail.com";

        // --- DOM Elements ---
        const mainContainer = document.querySelector('.container');
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        // Students
        const createStudentForm = document.getElementById('create-student-form');
        const studentListEl = document.getElementById('student-list');
        // Teachers
        const createTeacherForm = document.getElementById('create-teacher-form');
        const createTeacherStatusEl = document.getElementById('create-teacher-status');
        const teacherListEl = document.getElementById('teacher-list');
        // Subjects
        const createSubjectForm = document.getElementById('create-subject-form');
        const subjectTeacherSelect = document.getElementById('subject-teacher');
        const subjectListEl = document.getElementById('subject-list');
        const createSubjectStatusEl = document.getElementById('create-subject-status');
        const subjectClassFilterEl = document.getElementById('subject-class-filter');
        // Exams
        const createExamForm = document.getElementById('create-exam-form');
        const createExamStatusEl = document.getElementById('create-exam-status');
        const examClassSelect = document.getElementById('exam-class-select');
        const examSubjectSelect = document.getElementById('exam-subject-select');
        const examMaxMarksInput = document.getElementById('exam-max-marks');
        const addExamSubjectBtn = document.getElementById('add-exam-subject-btn');
        const examMarksListEl = document.getElementById('exam-marks-list');
        const examListEl = document.getElementById('exam-list');

        // --- Global State ---
        let allUnsubscribes = [], studentsCache = [], teachersCache = [], subjectsCache = [], examsCache = [];
        let currentExamMarks = [];

        // --- Auth & Initialization ---
        auth.onAuthStateChanged(user => {
            if (user && user.email === adminEmail) {
                mainContainer.style.display = 'block';
                userEmailEl.textContent = user.email;
                initializeAdminDashboard();
            } else { window.location.href = 'index.html'; }
        });

        logoutBtn.onclick = () => {
            allUnsubscribes.forEach(unsub => unsub());
            auth.signOut().then(() => window.location.href = 'index.html');
        };

        function initializeAdminDashboard() {
            listenForStudents();
            listenForTeachers();
            listenForSubjects();
            listenForExams();
            setupFormEventListeners();
            setupListEventListeners();
        }
        
        // --- UI Control ---
        function showTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        // --- Data Listeners ---
        function listenForStudents() {
            const unsub = db.collection('students').orderBy('name').onSnapshot(snap => {
                studentsCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStudentList();
            });
            allUnsubscribes.push(unsub);
        }
        function listenForTeachers() {
            const unsub = db.collection('teachers').orderBy('name').onSnapshot(snap => {
                teachersCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTeacherList();
                populateTeacherDropdowns();
            });
            allUnsubscribes.push(unsub);
        }
        function listenForSubjects() {
            const unsub = db.collection('subjects').onSnapshot(snap => {
                subjectsCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSubjectList();
            });
            allUnsubscribes.push(unsub);
        }
        function listenForExams() {
            const unsub = db.collection('exams').orderBy('createdAt', 'desc').onSnapshot(snap => {
                examsCache = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderExamList();
            });
            allUnsubscribes.push(unsub);
        }

        // --- Render Functions ---
        function renderStudentList() {
            studentListEl.innerHTML = studentsCache.map(s => `<div class="item-card"><div><p><strong>${s.name}</strong> (Roll: ${s.rollNo}, Class: ${s.class})</p></div><button class="btn btn-sm btn-delete" data-student-id="${s.id}">Delete</button></div>`).join('') || '<p>No students created yet.</p>';
        }
        function renderTeacherList() {
            teacherListEl.innerHTML = teachersCache.map(t => `<div class="item-card"><div><p><strong>${t.name}</strong></p><p><small>${t.email}</small></p></div><button class="btn btn-sm btn-delete" data-teacher-id="${t.id}" data-teacher-email="${t.email}">Delete</button></div>`).join('') || '<p>No teachers created yet.</p>';
        }
        function populateTeacherDropdowns() {
            const currentSelection = subjectTeacherSelect.value;
            subjectTeacherSelect.innerHTML = '<option value="">-- Select Teacher --</option>';
            teachersCache.forEach(teacher => subjectTeacherSelect.innerHTML += `<option value="${teacher.id}" data-teacher-name="${teacher.name}">${teacher.name}</option>`);
            subjectTeacherSelect.value = currentSelection;
        }
        function renderSubjectList() {
            const filter = subjectClassFilterEl.value;
            const filtered = (filter === 'all') ? subjectsCache : subjectsCache.filter(s => s.className === filter);
            subjectListEl.innerHTML = filtered.map(s => `<div class="item-card"><div><p><strong>${s.subjectName}</strong> (Class ${s.className})</p><p><small>Teacher: ${s.teacherName || 'Unassigned'}</small></p></div><button class="btn btn-sm btn-delete" data-subject-id="${s.id}">Delete</button></div>`).join('') || '<p>No subjects found for this class.</p>';
        }
        function renderExamList() {
            examListEl.innerHTML = examsCache.map(exam => `<div class="item-card"><div><p><strong>${exam.examName}</strong></p></div><button class="btn btn-sm btn-delete" data-exam-id="${exam.id}">Delete</button></div>`).join('') || '<p>No exams created yet.</p>';
        }

        // --- Event Listener Setup ---
        function setupFormEventListeners() {
            createStudentForm.addEventListener('submit', handleCreateStudent);
            createTeacherForm.addEventListener('submit', handleCreateTeacher);
            createSubjectForm.addEventListener('submit', handleCreateSubject);
            subjectClassFilterEl.addEventListener('change', renderSubjectList);
            createExamForm.addEventListener('submit', handleCreateExam);
            examClassSelect.addEventListener('change', handleExamClassChange);
            addExamSubjectBtn.addEventListener('click', handleAddExamSubject);
            examMarksListEl.addEventListener('click', handleRemoveExamSubject);
        }
        function setupListEventListeners() {
            studentListEl.addEventListener('click', e => { if(e.target.dataset.studentId) handleDelete(e.target.dataset.studentId, 'student', 'students'); });
            teacherListEl.addEventListener('click', e => { if(e.target.dataset.teacherId) handleSafeTeacherDelete(e.target.dataset.teacherId, e.target.dataset.teacherEmail); });
            subjectListEl.addEventListener('click', e => { if(e.target.dataset.subjectId) handleDelete(e.target.dataset.subjectId, 'subject', 'subjects'); });
            examListEl.addEventListener('click', e => { if(e.target.dataset.examId) handleDelete(e.target.dataset.examId, 'exam', 'exams'); });
        }

        // --- Handler Functions (Create) ---
        async function handleCreateStudent(e) { e.preventDefault(); try { await db.collection('students').add({ name: e.target.name.value, rollNo: e.target.rollNo.value, class: e.target.class.value }); createStudentForm.reset(); } catch (err) { alert(`Error: ${err.message}`); } }
        async function handleCreateTeacher(e) { e.preventDefault(); createTeacherStatusEl.textContent='Creating...'; try { const batch = db.batch(); batch.set(db.collection('teachers').doc(), { name: e.target['teacher-name'].value, email: e.target['teacher-email'].value }); batch.set(db.collection('users').doc(e.target['teacher-email'].value), { role: 'teacher' }); await batch.commit(); createTeacherStatusEl.textContent = 'Teacher created!'; createTeacherForm.reset(); } catch(err){ createTeacherStatusEl.textContent = `Error: ${err.message}`;} finally { setTimeout(()=>createTeacherStatusEl.textContent='', 3000);} }
        async function handleCreateSubject(e) { e.preventDefault(); createSubjectStatusEl.textContent='Creating...'; const selectedOpt = subjectTeacherSelect.options[subjectTeacherSelect.selectedIndex]; try { await db.collection('subjects').add({ className: document.getElementById('subject-class').value, subjectName: document.getElementById('subject-name').value.trim(), teacherId: selectedOpt.value, teacherName: selectedOpt.dataset.teacherName }); createSubjectStatusEl.textContent = 'Subject created!'; createSubjectForm.reset(); } catch (err) { createSubjectStatusEl.textContent = `Error: ${err.message}`; } finally { setTimeout(() => createSubjectStatusEl.textContent = '', 3000); } }
        async function handleCreateExam(e) { e.preventDefault(); const examName = document.getElementById('exam-name').value.trim(); if (!examName || currentExamMarks.length === 0) { alert('Please provide an exam name and configure at least one subject.'); return; } createExamStatusEl.textContent = 'Creating...'; const marksStructure = {}; currentExamMarks.forEach(item => { const key = `CLASS_${item.class}_${item.subject.replace(/\s+/g, '_').toUpperCase()}`; marksStructure[key] = item.marks; }); try { await db.collection('exams').add({ examName, marksStructure, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); createExamStatusEl.textContent = 'Exam created!'; createExamForm.reset(); currentExamMarks = []; renderCurrentExamMarks(); examSubjectSelect.disabled = true; } catch (err) { createExamStatusEl.textContent = `Error: ${err.message}`; } finally { setTimeout(() => createExamStatusEl.textContent = '', 3000); } }
        
        // --- Handler Functions (Exams Form) ---
        function handleExamClassChange() { const selectedClass = examClassSelect.value; examSubjectSelect.innerHTML = '<option value="">Subject</option>'; examSubjectSelect.disabled = true; if (!selectedClass) return; const subjectsForClass = subjectsCache.filter(s => s.className === selectedClass); if (subjectsForClass.length > 0) { subjectsForClass.forEach(s => examSubjectSelect.innerHTML += `<option value="${s.subjectName}">${s.subjectName}</option>`); examSubjectSelect.disabled = false; } }
        function handleAddExamSubject() { const className = examClassSelect.value, subjectName = examSubjectSelect.value, maxMarks = examMaxMarksInput.value; if (!className || !subjectName || !maxMarks) { alert('Please select a class, subject, and enter max marks.'); return; } if (currentExamMarks.some(item => item.class === className && item.subject === subjectName)) { alert('This subject has already been added.'); return; } currentExamMarks.push({ class: className, subject: subjectName, marks: parseInt(maxMarks) }); renderCurrentExamMarks(); examMaxMarksInput.value = ''; }
        function renderCurrentExamMarks() { examMarksListEl.innerHTML = currentExamMarks.map((item, index) => `<div class="marks-item"><span>Class ${item.class} - ${item.subject} (${item.marks} Marks)</span><button type="button" class="btn btn-sm btn-delete" data-index="${index}">Remove</button></div>`).join(''); }
        function handleRemoveExamSubject(e) { if (e.target.dataset.index) { currentExamMarks.splice(e.target.dataset.index, 1); renderCurrentExamMarks(); } }
        
        // --- Handler Functions (Delete) ---
        async function handleSafeTeacherDelete(teacherId, teacherEmail) {
            if (!confirm(`Are you sure you want to delete this teacher? They will be unassigned from all their subjects.`)) return;
            const batch = db.batch();
            try {
                // 1. Find all subjects taught by this teacher
                const subjectsQuery = await db.collection('subjects').where('teacherId', '==', teacherId).get();
                // 2. For each subject, update it to be unassigned
                subjectsQuery.forEach(doc => {
                    const subjectRef = db.collection('subjects').doc(doc.id);
                    batch.update(subjectRef, { teacherId: null, teacherName: null });
                });
                // 3. Delete the teacher's main profile and user role
                batch.delete(db.collection('teachers').doc(teacherId));
                batch.delete(db.collection('users').doc(teacherEmail));
                // 4. Commit all changes at once
                await batch.commit();
                alert('Teacher deleted and unassigned from subjects successfully.');
            } catch (err) {
                alert(`Error deleting teacher: ${err.message}`);
            }
        }
        function handleDelete(id, itemName, collectionName) {
            if (confirm(`Are you sure you want to delete this ${itemName}?`)) {
                db.collection(collectionName).doc(id).delete().catch(err => alert(`Error: ${err.message}`));
            }
        }
    </script>
</body>
</html>
