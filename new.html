<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - College Management System</title>
    <!-- Google Fonts: Inter and Material Symbols -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* 1. MODERN DESIGN SYSTEM & VARIABLES */
        :root {
            --font-primary: 'Inter', sans-serif;
            --color-primary: #1A73E8; /* Professional Blue */
            --color-primary-light: #E8F0FE;
            --color-danger: #D93025;
            
            --color-bg-app: #F8F9FA;
            --color-bg-surface: #FFFFFF;
            --color-bg-hover: #F1F5F9;
            
            --color-text-header: #202124;
            --color-text-body: #3C4043;
            --color-text-muted: #5F6368;

            --color-border: #DADCE0;

            --sidebar-width-collapsed: 80px;
            --sidebar-width-expanded: 256px;
            --navbar-height: 64px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition-speed: 0.25s;
            --ease-out-quad: cubic-bezier(0.4, 0, 0.2, 1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* 2. BASE & LAYOUT STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-primary);
            background-color: var(--color-bg-app);
            color: var(--color-text-body);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .dashboard-container {
            display: flex;
            width: 100%;
            height: 100%;
        }
        
        .material-symbols-outlined {
            vertical-align: middle;
            font-size: 20px;
            line-height: 1;
        }

        /* 3. ADAPTIVE SIDEBAR */
        .sidebar {
            background-color: var(--color-bg-surface);
            width: var(--sidebar-width-collapsed);
            flex-shrink: 0;
            padding: 16px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--color-border);
            transition: width var(--transition-speed) var(--ease-out-quad);
            overflow: hidden;
            z-index: 10;
        }
        
        .sidebar:hover { width: var(--sidebar-width-expanded); }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding: 4px;
            height: 44px;
        }
        
        .logo {
            width: 36px; height: 36px; min-width: 36px;
            background: var(--color-primary); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-weight: 700; font-size: 1.25rem; color: white;
        }
        
        .sidebar-title {
            font-size: 1.125rem; font-weight: 600; color: var(--color-text-header);
            white-space: nowrap; opacity: 0;
            transition: opacity 0.15s var(--ease-out-quad);
        }
        .sidebar:hover .sidebar-title { opacity: 1; transition-delay: 0.1s; }

        .sidebar-nav { flex-grow: 1; overflow-y: auto; overflow-x: hidden; }
        .nav-list { list-style: none; }

        .nav-link {
            display: flex; align-items: center; height: 44px;
            padding: 0 12px; margin: 4px 0; text-decoration: none;
            color: var(--color-text-body); border-radius: var(--radius-md);
            transition: background-color var(--transition-speed) var(--ease-out-quad);
            font-weight: 500; white-space: nowrap;
        }
        .nav-link .material-symbols-outlined { margin-right: 20px; color: var(--color-text-muted); }
        .nav-link:hover { background-color: var(--color-bg-hover); }

        .nav-text { opacity: 0; transition: opacity 0.15s var(--ease-out-quad); }
        .sidebar:hover .nav-text { opacity: 1; transition-delay: 0.1s; }

        /* 4. MAIN PANEL (HEADER + CONTENT) */
        .main-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .top-navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 32px;
            height: var(--navbar-height);
            background-color: var(--color-bg-surface);
            border-bottom: 1px solid var(--color-border);
            flex-shrink: 0;
        }

        .header-info h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-text-header);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .year-display {
            font-size: 0.9rem;
            color: var(--color-text-muted);
        }
        #current-year-display {
            font-weight: 600;
            color: var(--color-primary);
        }
        
        .user-info {
            font-size: 0.9rem;
            color: var(--color-text-muted);
        }

        .btn-logout {
            background-color: var(--color-danger);
            border: none;
            padding: 8px 16px;
            font-size: 14px;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: white;
            transition: background-color 0.2s;
        }
        .btn-logout:hover { background-color: #c5221f; }
        
        .page-content {
            flex-grow: 1;
            padding: 32px;
            overflow-y: auto;
        }

        /* 5. UPDATED DASHBOARD CARD STYLES */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5em;
        }
        .dashboard-card {
            display: flex; flex-direction: column; justify-content: space-between;
            background-color: var(--color-bg-surface);
            padding: 1.5em; border-radius: var(--radius-lg); text-decoration: none;
            color: var(--color-text-body);
            border-left: 4px solid var(--color-primary);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            border-top: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
            border-bottom: 1px solid var(--color-border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        .card-header { display: flex; align-items: center; gap: 0.75em; }
        .card-header .material-symbols-outlined { color: var(--color-primary); font-size: 28px; }
        .card-header h2 { margin: 0; color: var(--color-text-header); font-size: 1.25em; font-weight: 600; }
        .dashboard-card p { color: var(--color-text-muted); font-size: 0.9em; line-height: 1.5; flex-grow: 1; margin-top: 0.5rem; }
        .card-stat { font-size: 2em; font-weight: 700; color: var(--color-primary); text-align: right; margin-top: 1em; }
        .card-stat .subtext { font-size: 0.5em; font-weight: 500; color: var(--color-text-muted); }

        /* 6. RESPONSIVE ADJUSTMENTS */
        @media (max-width: 768px) {
            body { display: block; overflow-y: auto; }
            .sidebar { display: none; } /* Hide sidebar on mobile */
            .main-panel { height: auto; }
            .top-navbar { padding: 0 16px; flex-direction: column; height: auto; padding: 12px; gap: 8px; align-items: flex-start; }
            .page-content { padding: 16px; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }

    </style>
</head>
<body>
    <div class="dashboard-container" style="display: none;">
        <!-- === SIDEBAR NAVIGATION === -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">C</div>
                <span class="sidebar-title">CMS Admin</span>
            </div>
            <nav class="sidebar-nav">
                <ul class="nav-list">
                    <li><a href="manage-students.html" class="nav-link" title="Students"><span class="material-symbols-outlined">groups</span><span class="nav-text">Students</span></a></li>
                    <li><a href="manage-roles.html" class="nav-link" title="Roles & Staff"><span class="material-symbols-outlined">badge</span><span class="nav-text">Roles & Staff</span></a></li>
                    <li><a href="manage-subjects.html" class="nav-link" title="Subjects"><span class="material-symbols-outlined">menu_book</span><span class="nav-text">Subjects</span></a></li>
                    <li><a href="manage-exams.html" class="nav-link" title="Exams"><span class="material-symbols-outlined">assignment</span><span class="nav-text">Exams</span></a></li>
                    <li><a href="manage-fees.html" class="nav-link" title="Fees"><span class="material-symbols-outlined">payments</span><span class="nav-text">Fees</span></a></li>
                    <li><a href="manage-timetables.html" class="nav-link" title="Timetables"><span class="material-symbols-outlined">calendar_month</span><span class="nav-text">Timetables</span></a></li>
                    <li><a href="manage-notices.html" class="nav-link" title="Notices"><span class="material-symbols-outlined">campaign</span><span class="nav-text">Notices</span></a></li>
                    <li><a href="reports.html" class="nav-link" title="Reports"><span class="material-symbols-outlined">analytics</span><span class="nav-text">Reports</span></a></li>
                    <li><a href="archived-students.html" class="nav-link" title="Archives"><span class="material-symbols-outlined">archive</span><span class="nav-text">Archives</span></a></li>
                    <li><a href="manage-settings.html" class="nav-link" title="Settings"><span class="material-symbols-outlined">tune</span><span class="nav-text">Settings</span></a></li>
                    <li><a href="admin-tools.html" class="nav-link" title="System Tools"><span class="material-symbols-outlined">construction</span><span class="nav-text">System Tools</span></a></li>
                </ul>
            </nav>
        </aside>

        <!-- === MAIN CONTENT PANEL === -->
        <main class="main-panel">
            <header class="top-navbar">
                <div class="header-info">
                    <h1>Admin Dashboard</h1>
                </div>
                <div class="header-actions">
                    <div class="year-display">Academic Year: <span id="current-year-display">Loading...</span></div>
                    <div class="user-info">Logged in as: <strong id="user-email"></strong></div>
                    <button id="logout-btn" class="btn-logout">Logout</button>
                </div>
            </header>
            
            <div class="page-content">
                <div class="dashboard-grid">
                    <a href="manage-students.html" class="dashboard-card">
                        <div>
                            <div class="card-header">
                                <span class="material-symbols-outlined">groups</span>
                                <h2>Students</h2>
                            </div>
                            <p>Manage active student profiles for the current academic year.</p>
                        </div>
                        <div class="card-stat" id="student-count">...</div>
                    </a>
                    <a href="manage-roles.html" class="dashboard-card">
                        <div>
                            <div class="card-header">
                                <span class="material-symbols-outlined">badge</span>
                                <h2>Roles & Staff</h2>
                            </div>
                            <p>Assign roles and manage all non-student user accounts.</p>
                        </div>
                        <div class="card-stat" id="teacher-count">...</div>
                    </a>
                    <a href="manage-subjects.html" class="dashboard-card">
                         <div>
                            <div class="card-header">
                                <span class="material-symbols-outlined">menu_book</span>
                                <h2>Subjects</h2>
                            </div>
                            <p>Define subjects for each class and assign teachers for the current year.</p>
                        </div>
                        <div class="card-stat" id="subject-count">...</div>
                    </a>
                    <a href="manage-exams.html" class="dashboard-card">
                         <div>
                            <div class="card-header">
                                <span class="material-symbols-outlined">assignment</span>
                                <h2>Exams</h2>
                            </div>
                            <p>Create and publish exam units and configure their marks structure.</p>
                        </div>
                        <div class="card-stat" id="exam-count">...</div>
                    </a>
                    <a href="manage-fees.html" class="dashboard-card">
                        <div>
                           <div class="card-header">
                               <span class="material-symbols-outlined">payments</span>
                               <h2>Fees</h2>
                           </div>
                           <p>Define fee structures, generate invoices, and track payments.</p>
                       </div>
                        <div class="card-stat" id="invoice-count">...</div>
                   </a>
                    <a href="manage-timetables.html" class="dashboard-card">
                         <div>
                            <div class="card-header">
                                <span class="material-symbols-outlined">calendar_month</span>
                                <h2>Timetables</h2>
                            </div>
                            <p>Create and manage the weekly class schedule for all classes.</p>
                        </div>
                         <div class="card-stat">Manage</div>
                    </a>
                    <a href="manage-notices.html" class="dashboard-card">
                        <div>
                            <div class="card-header">
                                <span class="material-symbols-outlined">campaign</span>
                                <h2>Notices</h2>
                            </div>
                            <p>Publish school-wide announcements for students and teachers.</p>
                        </div>
                         <div class="card-stat" id="notice-count">...</div>
                    </a>
                    <a href="reports.html" class="dashboard-card">
                        <div>
                            <div class="card-header">
                                <span class="material-symbols-outlined">analytics</span>
                                <h2>Reports</h2>
                            </div>
                            <p>Generate mark sheets, attendance reports, and student report cards.</p>
                        </div>
                         <div class="card-stat">View</div>
                    </a>
                     <a href="archived-students.html" class="dashboard-card">
                         <div>
                            <div class="card-header">
                                <span class="material-symbols-outlined">archive</span>
                                <h2>Archives</h2>
                            </div>
                            <p>View records of students who have graduated or left the school.</p>
                        </div>
                         <div class="card-stat" id="archived-count">...</div>
                    </a>
                    <a href="manage-settings.html" class="dashboard-card">
                         <div>
                            <div class="card-header">
                               <span class="material-symbols-outlined">tune</span>
                               <h2>Settings</h2>
                            </div>
                            <p>Configure the academic year, grading policies, and school information.</p>
                        </div>
                         <div class="card-stat">Configure</div>
                    </a>
                     <a href="admin-tools.html" class="dashboard-card">
                        <div>
                            <div class="card-header">
                                <span class="material-symbols-outlined">construction</span>
                                <h2>System Tools</h2>
                            </div>
                            <p>Perform critical operations like year-end promotion and bulk data imports.</p>
                        </div>
                         <div class="card-stat"><span class="subtext">Advanced</span>Tools</div>
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- NO CHANGES WERE MADE TO THE JAVASCRIPT ---
        // It will work exactly as before, populating the cards in the main content area.
        const firebaseConfig = {
            apiKey: "AIzaSyAtDp9cTE1fYFM2PZjgQ1r1YBoSOcwhIS8",
            authDomain: "collage-management-696b3.firebaseapp.com",
            projectId: "collage-management-696b3",
            storageBucket: "collage-management-696b3.firebasestorage.app",
            messagingSenderId: "489625618034",
            appId: "1:489625618034:web:f6ba20e80715f70e4264eb",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const adminEmail = "harshavardhanjw@gmail.com";

        let CURRENT_ACADEMIC_YEAR = null;
        const mainContainer = document.querySelector('.dashboard-container'); // Updated selector
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        
        auth.onAuthStateChanged(user => {
            if (user && user.email === adminEmail) {
                mainContainer.style.display = 'flex'; // Use flex for the new layout
                userEmailEl.textContent = user.email;
                initializeDashboard();
            } else {
                window.location.href = 'index.html';
            }
        });

        logoutBtn.onclick = () => auth.signOut().then(() => {
            window.location.href = 'index.html';
        });

        async function initializeDashboard() {
            try {
                await fetchGlobalSettings();
                fetchDashboardStats();
            } catch (error) {
                document.body.innerHTML = `<h1>Critical Error</h1><p>${error.message}</p><p>Please ensure you have created the 'settings/global' document in Firestore with a 'currentAcademicYear' field.</p>`;
            }
        }
        
        async function fetchGlobalSettings() {
            const settingsRef = db.collection('settings').doc('global');
            const doc = await settingsRef.get();
            if (!doc.exists || !doc.data().currentAcademicYear) {
                throw new Error("Global settings not found or 'currentAcademicYear' is not set.");
            }
            CURRENT_ACADEMIC_YEAR = doc.data().currentAcademicYear;
            document.getElementById('current-year-display').textContent = CURRENT_ACADEMIC_YEAR;
        }
        
        async function fetchDashboardStats() {
            if (!CURRENT_ACADEMIC_YEAR) return;

            const studentCountEl = document.getElementById('student-count');
            const teacherCountEl = document.getElementById('teacher-count');
            const subjectCountEl = document.getElementById('subject-count');
            const examCountEl = document.getElementById('exam-count');
            const noticeCountEl = document.getElementById('notice-count');
            const invoiceCountEl = document.getElementById('invoice-count');
            const archivedCountEl = document.getElementById('archived-count');

            try {
                const [studentSnap, teacherSnap, subjectSnap, examSnap, noticeSnap, archivedSnap, invoiceSnap] = await Promise.all([
                    db.collection('students').get(),
                    db.collection('teachers').get(),
                    db.collection('subjects').get(),
                    db.collection('exams').get(),
                    db.collection('notices').get(),
                    db.collection('students').where('status', 'in', ['graduated', 'Left School']).get(),
                    db.collection('invoices').where('academicYear', '==', CURRENT_ACADEMIC_YEAR).get()
                ]);

                const activeStudents = studentSnap.docs.filter(doc => {
                    const data = doc.data();
                    return (data.status === 'active' || !data.status) && (!data.academicYear || data.academicYear === CURRENT_ACADEMIC_YEAR);
                });
                const currentSubjects = subjectSnap.docs.filter(doc => !doc.data().academicYear || doc.data().academicYear === CURRENT_ACADEMIC_YEAR);
                const currentExams = examSnap.docs.filter(doc => !doc.data().academicYear || doc.data().academicYear === CURRENT_ACADEMIC_YEAR);

                studentCountEl.textContent = activeStudents.length;
                teacherCountEl.textContent = teacherSnap.size;
                subjectCountEl.textContent = currentSubjects.length;
                examCountEl.textContent = currentExams.length;
                noticeCountEl.textContent = noticeSnap.size;
                invoiceCountEl.textContent = invoiceSnap.size;
                archivedCountEl.textContent = archivedSnap.size;

            } catch (error) {
                console.error("Error fetching dashboard stats:", error);
                [studentCountEl, teacherCountEl, subjectCountEl, examCountEl, noticeCountEl, invoiceCountEl, archivedCountEl].forEach(el => {
                    if(el) el.textContent = 'Error';
                });
            }
        }
    </script>
</body>
</html>
