<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - College Management System</title>
    <style>
        :root {
            --primary-color: #3498db; --danger-color: #e74c3c; --success-color: #27ae60; --warning-color: #f39c12;
            --light-bg: #f4f7f9; --dark-text: #2c3e50; --light-text: #7f8c8d;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-bg); margin: 0; padding: 2em 0; display: flex;
            justify-content: center; align-items: flex-start; min-height: 100vh; color: var(--dark-text);
        }
        .container {
            width: 95%; max-width: 900px; background: white; padding: 2em; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 { color: var(--dark-text); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 1em; margin-bottom: 2em; }
        .header-actions { display: flex; gap: 1em; }
        .btn { border: none; padding: 10px 15px; font-size: 14px; border-radius: 4px; cursor: pointer; color: white; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-logout { background-color: var(--danger-color); }
        .btn-switch { background-color: var(--warning-color); }
        
        .student-item { background: #ecf0f1; padding: 1em; border-radius: 4px; margin-bottom: 0.8em; border-left: 5px solid var(--primary-color); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2em; margin-top: 2em; }
        
        /* Profile Selector Styles */
        #profile-selector-view { text-align: center; }
        .profile-card { display: block; background: #fff; border: 1px solid #ddd; padding: 1.5em; border-radius: 8px; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; text-align: left; }
        .profile-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        /* Attendance & Marks Styles */
        .attendance-summary { background: var(--light-bg); padding: 1em; border-radius: 8px; margin-top: 1em; }
        .percentage-bar { background: #e0e0e0; border-radius: 5px; overflow: hidden; height: 25px; margin-top: 0.5em; }
        .percentage-fill { background: var(--success-color); height: 100%; text-align: center; color: white; line-height: 25px; transition: width 0.5s; font-weight: bold; }
        .marks-table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .marks-table th, .marks-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .marks-table th { background-color: var(--light-bg); }
    </style>
</head>
<body>
    <div class="container" style="display: none;">
        <div id="app-header" class="header">
            <div class="header-info"><h1 id="header-title">Student Dashboard</h1><p>Logged in as: <strong id="user-email"></strong></p></div>
            <div class="header-actions">
                <button id="switch-student-btn" class="btn btn-switch" style="display: none;">Switch Student</button>
                <button id="logout-btn" class="btn btn-logout">Logout</button>
            </div>
        </div>

        <!-- View 1: Profile Selector (Shown if multiple profiles are linked to one email) -->
        <div id="profile-selector-view" style="display: none;">
            <h2>Select a Student Profile</h2>
            <p>This account is linked to multiple students. Please choose a profile to view.</p>
            <div id="profile-list" class="dashboard-grid"></div>
        </div>

        <!-- View 2: Main Student Dashboard (Shown after a profile is selected) -->
        <div id="student-dashboard-view" style="display: none;">
            <div id="student-details-content"></div>
            <div class="dashboard-grid">
                <div id="attendance-section">
                    <h3>My Attendance</h3>
                    <div id="attendance-summary-container"></div>
                </div>
                <div id="marks-section">
                    <h3>My Exam Results</h3>
                    <div id="exam-marks-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAtDp9cTE1fYFM2PZjgQ1r1YBoSOcwhIS8",
            authDomain: "collage-management-696b3.firebaseapp.com",
            projectId: "collage-management-696b3",
            storageBucket: "collage-management-696b3.firebasestorage.app",
            messagingSenderId: "489625618034",
            appId: "1:489625618034:web:f6ba20e80715f70e4264eb",
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const mainContainer = document.querySelector('.container');
        const userEmailEl = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logout-btn');
        const switchStudentBtn = document.getElementById('switch-student-btn');
        const profileSelectorView = document.getElementById('profile-selector-view');
        const profileList = document.getElementById('profile-list');
        const studentDashboardView = document.getElementById('student-dashboard-view');
        const studentDetailsContent = document.getElementById('student-details-content');
        const attendanceSummaryContainer = document.getElementById('attendance-summary-container');
        const examMarksContainer = document.getElementById('exam-marks-container');

        // Global State
        let linkedStudentProfiles = [];
        let CURRENT_ACADEMIC_YEAR = null;
        let attendanceUnsubscribe = null;

        // --- AUTH & INITIALIZATION ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                const userDoc = await db.collection('users').doc(user.email).get();
                if (userDoc.exists && userDoc.data().role === 'student') {
                    await fetchGlobalSettings();
                    mainContainer.style.display = 'block';
                    userEmailEl.textContent = user.email;
                    initializeStudentDashboard(user.email);
                } else {
                    handleAuthError('Access Denied. You do not have student permissions.');
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function handleAuthError(message) { alert(message); auth.signOut().then(() => window.location.href = 'index.html'); }
        logoutBtn.onclick = () => { if (attendanceUnsubscribe) attendanceUnsubscribe(); auth.signOut(); };
        switchStudentBtn.onclick = () => showProfileSelector();
        
        async function fetchGlobalSettings() {
            try {
                const settingsRef = db.collection('settings').doc('global');
                const doc = await settingsRef.get();
                if (doc.exists) CURRENT_ACADEMIC_YEAR = doc.data().currentAcademicYear;
            } catch(e) { console.error("Could not fetch academic year settings."); CURRENT_ACADEMIC_YEAR = null; }
        }

        async function initializeStudentDashboard(email) {
            // Fetch ALL student profiles associated with this email
            const studentSnap = await db.collection('students').where('email', '==', email).get();
            
            if (studentSnap.empty) {
                studentDashboardView.innerHTML = '<h2>Error: Your student profile could not be found. Please contact an administrator.</h2>';
                studentDashboardView.style.display = 'block';
                return;
            }

            linkedStudentProfiles = studentSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (linkedStudentProfiles.length > 1) {
                // If more than one profile, show the selector screen
                showProfileSelector();
            } else {
                // If only one, load the dashboard directly
                loadDashboardForStudent(linkedStudentProfiles[0]);
            }
        }

        // --- UI VIEW MANAGEMENT ---
        function showProfileSelector() {
            studentDashboardView.style.display = 'none';
            profileSelectorView.style.display = 'block';
            if(linkedStudentProfiles.length > 1) switchStudentBtn.style.display = 'inline-block';

            profileList.innerHTML = linkedStudentProfiles.map(profile => `
                <div class="profile-card" data-id="${profile.id}">
                    <h2>${profile.name}</h2>
                    <p><strong>Class:</strong> ${profile.class} | <strong>Roll No:</strong> ${profile.rollNo}</p>
                </div>
            `).join('');
            
            // Add event listeners to the newly created profile cards
            document.querySelectorAll('.profile-card').forEach(card => {
                card.onclick = () => {
                    const selectedProfile = linkedStudentProfiles.find(p => p.id === card.dataset.id);
                    loadDashboardForStudent(selectedProfile);
                };
            });
        }

        function loadDashboardForStudent(profile) {
            profileSelectorView.style.display = 'none';
            studentDashboardView.style.display = 'block';
            
            // Render basic details
            studentDetailsContent.innerHTML = `
                <h2>Welcome, ${profile.name}!</h2>
                <div class="student-item" style="text-align:left; display:block;">
                    <p><strong>Roll No:</strong> ${profile.rollNo}</p>
                    <p><strong>Class:</strong> ${profile.class}</p>
                    <p><strong>Academic Year:</strong> ${profile.academicYear || 'N/A'}</p>
                </div>`;
            
            // Fetch and render data specific to this student
            listenForStudentAttendance(profile.id, profile.academicYear);
            fetchExamMarks(profile.id, profile.academicYear);
        }

        // --- DATA FETCHING FOR DASHBOARD ---
        function listenForStudentAttendance(studentId, academicYear) {
            if (attendanceUnsubscribe) attendanceUnsubscribe();
            
            let query = db.collection('attendance');
            if (academicYear) query = query.where('academicYear', '==', academicYear);

            attendanceUnsubscribe = query.onSnapshot(snap => {
                const myRecords = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    if(data.records && data.records[studentId]) {
                        myRecords.push({ date: data.date, status: data.records[studentId] });
                    }
                });
                renderAttendanceSummary(myRecords);
            });
        }

        async function fetchExamMarks(studentId, academicYear) {
            examMarksContainer.innerHTML = '<p>Loading exam results...</p>';
            
            // 1. Get all exams for the student's academic year (or global if not set)
            let examsQuery = db.collection('exams');
            const studentYear = academicYear || CURRENT_ACADEMIC_YEAR;
            if(studentYear) examsQuery = examsQuery.where('academicYear', '==', studentYear);
            
            const examsSnap = await examsQuery.get();
            if(examsSnap.empty) {
                examMarksContainer.innerHTML = '<p>No exams have been scheduled for this academic year.</p>';
                return;
            }

            const exams = examsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const examIds = exams.map(e => e.id);

            // 2. Find any marks documents for this student for those exams
            const marksSnap = await db.collection('marks').where('studentId', '==', studentId).where('examId', 'in', examIds).get();
            
            if (marksSnap.empty) {
                examMarksContainer.innerHTML = '<p>No marks have been entered for you yet.</p>';
                return;
            }

            // 3. Process and render the marks
            let tableHtml = '<table class="marks-table"><thead><tr><th>Exam</th><th>Subject</th><th>Marks</th><th>Max Marks</th></tr></thead><tbody>';
            let marksFound = false;

            marksSnap.forEach(doc => {
                const markData = doc.data();
                const exam = exams.find(e => e.id === markData.examId);
                
                for (const subject in markData.marks) {
                    marksFound = true;
                    const marksKey = `CLASS_${markData.class}_${subject.replace(/\s+/g, '_').toUpperCase()}`;
                    const maxMarks = exam.marksStructure[marksKey] || '-';
                    tableHtml += `<tr>
                                    <td>${markData.examName}</td>
                                    <td>${subject}</td>
                                    <td>${markData.marks[subject]}</td>
                                    <td>${maxMarks}</td>
                                  </tr>`;
                }
            });

            tableHtml += '</tbody></table>';
            
            if (marksFound) {
                examMarksContainer.innerHTML = tableHtml;
            } else {
                 examMarksContainer.innerHTML = '<p>No marks have been entered for you yet.</p>';
            }
        }

        function renderAttendanceSummary(records) {
            const total = records.length;
            if (total === 0) {
                attendanceSummaryContainer.innerHTML = '<p>No attendance records found yet.</p>';
                return;
            }
            const present = records.filter(r => r.status === 'present').length;
            const percentage = Math.round((present / total) * 100);
            attendanceSummaryContainer.innerHTML = `<div class="attendance-summary">
                    <h4>Overall Attendance: ${present} / ${total} Days</h4>
                    <div class="percentage-bar"><div class="percentage-fill" style="width: ${percentage}%;">${percentage}%</div></div>
                </div>`;
        }
    </script>
</body>
</html>
